<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Splitter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    .pdf-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 20px;
    }
    canvas {
      border: 1px solid #ddd;
      margin: 5px;
    }
    .controls {
      margin: 20px 0;
    }
    input {
      margin: 5px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.15.349/pdf.min.js"></script>
</head>
<body>
  <h1>PDF Splitter</h1>
  <input type="file" id="pdfUpload" accept="application/pdf">
  <div class="controls">
    <label for="startPage">First Page:</label>
    <input type="number" id="startPage" min="1" placeholder="e.g., 1">
    <label for="endPage">Last Page:</label>
    <input type="number" id="endPage" min="1" placeholder="e.g., 3">
    <button id="splitButton">Split PDF</button>
  </div>
  <div class="pdf-container" id="pdfPreview"></div>
  <script>
    const pdfUpload = document.getElementById("pdfUpload");
    const splitButton = document.getElementById("splitButton");
    const startPage = document.getElementById("startPage");
    const endPage = document.getElementById("endPage");
    const pdfPreview = document.getElementById("pdfPreview");

    let uploadedPdfBytes = null;

    pdfUpload.addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (file) {
        try {
          console.log("Uploading PDF...");
          uploadedPdfBytes = await file.arrayBuffer();
          console.log("PDF uploaded successfully.");
          renderPdf(uploadedPdfBytes);
        } catch (error) {
          console.error("Error uploading PDF:", error);
        }
      } else {
        console.warn("No file selected.");
      }
    });

    splitButton.addEventListener("click", async () => {
      if (!uploadedPdfBytes) {
        alert("Please upload a PDF first.");
        console.warn("Split button clicked without PDF upload.");
        return;
      }
      const start = parseInt(startPage.value, 10);
      const end = parseInt(endPage.value, 10);

      if (isNaN(start) || isNaN(end) || start > end) {
        alert("Please provide a valid page range.");
        console.error("Invalid page range:", { start, end });
        return;
      }

      try {
        console.log(`Splitting PDF from page ${start} to ${end}...`);
        const splitPdfBytes = await splitPdf(uploadedPdfBytes, start, end);
        console.log("PDF split successfully. Rendering split pages...");
        renderPdf(splitPdfBytes);
      } catch (error) {
        console.error("Error splitting PDF:", error);
      }
    });

    async function renderPdf(pdfBytes) {
      try {
        console.log("Rendering PDF...");
        const loadingTask = pdfjsLib.getDocument({ data: pdfBytes });
        const pdf = await loadingTask.promise;
        pdfPreview.innerHTML = ""; // Clear previous previews

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          const viewport = page.getViewport({ scale: 1.5 });
          canvas.width = viewport.width;
          canvas.height = viewport.height;

          await page.render({ canvasContext: context, viewport }).promise;
          pdfPreview.appendChild(canvas);
        }
        console.log("PDF rendered successfully.");
      } catch (error) {
        console.error("Error rendering PDF:", error);
      }
    }

    async function splitPdf(pdfBytes, startPage, endPage) {
      try {
        console.log("Splitting PDF...");
        const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
        const newPdf = await PDFLib.PDFDocument.create();

        for (let i = startPage - 1; i < endPage; i++) {
          if (i < pdfDoc.getPageCount()) {
            const [copiedPage] = await newPdf.copyPages(pdfDoc, [i]);
            newPdf.addPage(copiedPage);
          } else {
            console.warn(`Page ${i + 1} does not exist in the document.`);
          }
        }

        const splitBytes = await newPdf.save();
        console.log("Split operation completed. Returning new PDF bytes.");
        return splitBytes;
      } catch (error) {
        console.error("Error during PDF splitting:", error);
        throw error;
      }
    }
  </script>
</body>
</html>
